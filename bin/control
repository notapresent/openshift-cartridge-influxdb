#!/bin/bash

source $OPENSHIFT_CARTRIDGE_SDK_BASH

function is_running() {
  if [ ! -z "$(ps -ef | grep 'influxd run' | grep -v grep)" ]; then
    return 0
  else
    return 1
  fi
}

function start() {
  if is_running; then
    client_result 'InfluxDB is already running.'
    return
  fi

  client_message "Starting InfluxDB..."
  nohup ${OPENSHIFT_DATA_DIR}influxdb/bin/influxd run \
    |& /usr/bin/logshifter -tag influxdb &
  i=0
  while ! is_running && [ $i -lt 60 ]; do
    sleep 1
    i=$(($i + 1))
  done

  if is_running; then
    client_result 'InfluxdbDB started.'
    makedb
  else
    client_result 'Warning! Could not start InfluxDB!'
    exit 1
  fi
}

function stop() {
  if ! is_running; then
      client_result 'InfluxDB is already stopped.'
  else
    client_message 'Stopping InfluxDB...'
    kill "$(ps -ef | grep 'influxd run' | grep -v grep | awk '{ print $2 }')" > /dev/null 2>&1
    i=0
    while is_running && [ $i -lt 60 ]; do
      sleep 1
      i=$(($i + 1))
    done
    if is_running; then
      client_result 'Warning! Could not stop InfluxDB!'
      exit 1
    else
      client_result 'InfluxDB stopped.'
    fi
  fi
}

function restart() {
  stop
  start
}

function status() {
  if is_running; then
    client_result 'InfluxDB appears to be running.'
  else
    client_result 'InfluxDB appears to be stopped.'
  fi
}

function tidy() {
  shopt -s dotglob
  client_message "Emptying logs in ${OPENSHIFT_LOG_DIR}..."
  rm -rf ${OPENSHIFT_LOG_DIR}/influxdb.log*
  client_message 'Done.'
}

function makedb() {
  $marker_file="${OPENSHIFT_DATA_DIR}influxdb/.default_db_created"
  if [ ! -f $marker_file ]; then
      client_message "Creating default database ${OPENSHIFT_APP_NAME}"
      curl -i -XPOST http://${OPENSHIFT_INFLUXDB_IP}:${OPENSHIFT_INFLUXDB_PORT}/query --data-urlencode "q=CREATE DATABASE '${OPENSHIFT_APP_NAME}'"
      touch $marker_file
  else
    client_message "Default database exists"
  fi  
}

case ${1} in
  start)   start   ;;
  stop)    stop    ;;
  restart) restart ;;
  status)  status  ;;
  tidy)    tidy    ;;
  *)       exit 0
esac
