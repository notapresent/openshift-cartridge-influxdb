#!/bin/bash

source $OPENSHIFT_CARTRIDGE_SDK_BASH


if [[ "${OPENSHIFT_APP_NAME}" =~ ^[0-9] ]]; then
  client_error ""
  client_error "Unable to add InfluxdbDB cartridge to your application because"
  client_error "your application name (${OPENSHIFT_APP_NAME}) starts with number."
  client_error ""
  client_error "ERROR: InfluxDB databases cannot start with number character."
  client_error ""
  exit 137
fi

# Create directories if necessary
mkdir -p $OPENSHIFT_INFLUXDB_DIR/{data/meta,data/wal,data/databases}


# Download
curl -L -o tmp.tgz https://dl.influxdata.com/influxdb/releases/influxdb-${2}_linux_amd64.tar.gz

# Copy required binaries
tar -xvzf tmp.tgz --strip-components=3 ./influxdb-${2}-1/usr/bin/{influxd,influx,influx_inspect}

# Remove downloaded archive
rm tmp.tgz


echo "influxdb://$OPENSHIFT_INFLUXDB_DB_HOST:$OPENSHIFT_INFLUXDB_DB_PORT/" > $OPENSHIFT_INFLUXDB_DIR/env/OPENSHIFT_INFLUX_URL

client_result ""
client_result "InfluxDB ${version} database added.  Please make note of these credentials:"
client_result ""
client_result "   Database Name: $OPENSHIFT_APP_NAME"
client_result ""
client_result 'Connection URL: influxdb://$OPENSHIFT_INFLUXDB_DB_HOST:$OPENSHIFT_INFLUXDB_DB_PORT/$OPENSHIFT_APP_NAME'
