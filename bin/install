#!/bin/bash

case "$1" in
  -v|--version)
    version="$2"
esac

source $OPENSHIFT_CARTRIDGE_SDK_BASH


if [[ "${OPENSHIFT_APP_NAME}" =~ ^[0-9] ]]; then
  client_error ""
  client_error "Unable to add InfluxdbDB cartridge to your application because"
  client_error "your application name (${OPENSHIFT_APP_NAME}) starts with number."
  client_error ""
  client_error "ERROR: InfluxDB databases cannot start with number character."
  client_error ""
  exit 137
fi

# Create directories if necessary
mkdir -p $OPENSHIFT_INFLUXDB_DIR/{data/meta,data/wal,data/databases}


# Download
curl -L -o tmp.tgz https://dl.influxdata.com/influxdb/releases/influxdb-${2}_linux_amd64.tar.gz

# Copy required binaries
tar -xvzf tmp.tgz --strip-components=3 ./influxdb-${2}-1/usr/bin/{influxd,influx,influx_inspect}

# Remove downloaded archive
rm tmp.tgz


# Create history file
touch  "${OPENSHIFT_DATA_DIR}influx_history"
ln -s  "${OPENSHIFT_DATA_DIR}influx_history" "${OPENSHIFT_HOMEDIR}.influx_history"


if [ -z "$OPENSHIFT_INFLUXDB_PROXY_PORT" ]; then
  # Since $OPENSHIFT_INFLUXDB_PROXY_PORT is missing, cartridge must be running in the main gear
  conn_url="influxdb://$OPENSHIFT_INFLUXDB_IP:$OPENSHIFT_INFLUXDB_PORT/$OPENSHIFT_APP_NAME"
else
  # Found $OPENSHIFT_INFLUXDB_PROXY_PORT, the cartridge is running in a separate gear
  conn_url="influxdb://$OPENSHIFT_GEAR_DNS:$OPENSHIFT_INFLUXDB_PROXY_PORT/$OPENSHIFT_APP_NAME"
fi

echo $conn_url > $OPENSHIFT_INFLUXDB_DIR/env/OPENSHIFT_INFLUXDB_URL

client_result ""
client_result "InfluxDB ${version} database added."
client_result "Connection URL: ${conn_url}"
client_result ""
